<!doctype html><html lang=en><head><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://use.fontawesome.com crossorigin><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=preconnect href=https://www.google-analytics.com crossorigin><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blakeniemyjski.com\/"},"articleSection":"blog","name":"Hello Home Automation, How-to detect battery levels with Node-RED","headline":"Hello Home Automation, How-to detect battery levels with Node-RED","description":"I\u0026rsquo;ve decided to start off 2020 by converting my blog to Hugo and start blogging again! This is my first of many posts on home automation! This post is going to cover generically detecting battery levels with Home Assistant and Node-RED.\n TLDR: Use the Function node defined in the Node-RED snippet here to properly handle all the edge cases.\n I decided to share my experiences based on seeing what others were doing in this thread.","inLanguage":"en","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"3030","datePublished":"2020-02-03 00:39:00 -0600 -0600","dateModified":"2020-02-03 00:39:00 -0600 -0600","url":"https:\/\/blakeniemyjski.com\/blog\/hello-home-automation-how-to-detect-battery-levels-with-node-red\/","wordCount":"629","keywords":["Home Assistant","Z-Wave","Battery","Device State","Node-RED","Automation","Smart Home","binary_sensor","sensor","Acceptance Factor","Blog"]}</script><title>Hello Home Automation, How-to detect battery levels with Node-RED</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.81.0"><meta name=description content="Blake Niemyjski"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hello Home Automation, How-to detect battery levels with Node-RED"><meta name=twitter:description content="I&rsquo;ve decided to start off 2020 by converting my blog to Hugo and start blogging again! This is my first of many posts on home automation! This post is going to cover generically detecting battery levels with Home Assistant and Node-RED.
 TLDR: Use the Function node defined in the Node-RED snippet here to properly handle all the edge cases.
 I decided to share my experiences based on seeing what others were doing in this thread."><meta name=twitter:site content="@blaken"><meta property="og:title" content="Hello Home Automation, How-to detect battery levels with Node-RED"><meta property="og:description" content="I&rsquo;ve decided to start off 2020 by converting my blog to Hugo and start blogging again! This is my first of many posts on home automation! This post is going to cover generically detecting battery levels with Home Assistant and Node-RED.
 TLDR: Use the Function node defined in the Node-RED snippet here to properly handle all the edge cases.
 I decided to share my experiences based on seeing what others were doing in this thread."><meta property="og:type" content="article"><meta property="og:url" content="https://blakeniemyjski.com/blog/hello-home-automation-how-to-detect-battery-levels-with-node-red/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-02-03T00:39:00-06:00"><meta property="article:modified_time" content="2020-02-03T00:39:00-06:00"><meta property="og:image" content="https://blakeniemyjski.com//images/logo.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="512"><meta property="og:image:height" content="512"><meta itemprop=name content="Hello Home Automation, How-to detect battery levels with Node-RED"><meta itemprop=description content="I&rsquo;ve decided to start off 2020 by converting my blog to Hugo and start blogging again! This is my first of many posts on home automation! This post is going to cover generically detecting battery levels with Home Assistant and Node-RED.
 TLDR: Use the Function node defined in the Node-RED snippet here to properly handle all the edge cases.
 I decided to share my experiences based on seeing what others were doing in this thread."><meta itemprop=datePublished content="2020-02-03T00:39:00-06:00"><meta itemprop=dateModified content="2020-02-03T00:39:00-06:00"><meta itemprop=wordCount content="629"><meta itemprop=keywords content="Home Assistant,Z-Wave,Battery,Device State,Node-RED,Automation,Smart Home,binary_sensor,sensor,Acceptance Factor,"><link rel=preload as=style href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap"></noscript><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css><link rel=stylesheet href=https://blakeniemyjski.com/css/main.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/styles/vs.min.css rel=stylesheet type=text/css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-3422587-1','auto'),ga('send','pageview'))</script></head><body><div id=wrapper><header id=header><h1><a href=https://blakeniemyjski.com/>blog</a></h1><nav class=links><ul><li><a href=https://blakeniemyjski.com/><i class="fas fa-home"></i>&nbsp;Home</a></li><li><a href=https://blakeniemyjski.com/categories/home-automation/><i class="fas fa-magic"></i>&nbsp;Home Automation</a></li><li><a href=https://blakeniemyjski.com/categories/programming/><i class="fas fa-code"></i>&nbsp;Programming</a></li><li><a href=https://blakeniemyjski.com/categories/review/><i class="fas fa-book"></i>&nbsp;Reviews</a></li><li><a href=https://blakeniemyjski.com/categories/public-speaking/><i class="fas fa-comments"></i>&nbsp;Public Speaking</a></li><li><a href=https://blakeniemyjski.com/about/><i class="fas fa-id-card"></i>&nbsp;About</a></li></ul></nav><nav class=main><ul><li id=share-nav class=share-menu style=display:none><a class=fa-share-alt href=#share-menu>Share</a></li><li class=search><a class=fa-search href=#search>Search</a><form id=search method=get action=//google.com/search><input type=text name=q placeholder=Search aria-label=Search>
<input type=hidden name=as_sitesearch value=https://blakeniemyjski.com/></form></li><li class=menu><a class=fa-bars href=#menu>Menu</a></li></ul></nav></header><section id=menu><section><form class=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=https://blakeniemyjski.com/></form></section><section><ul class=links><li><a href=https://blakeniemyjski.com/><h3><i class="fas fa-home"></i>&nbsp;Home</h3></a></li><li><a href=https://blakeniemyjski.com/categories/home-automation/><h3><i class="fas fa-magic"></i>&nbsp;Home Automation</h3></a></li><li><a href=https://blakeniemyjski.com/categories/programming/><h3><i class="fas fa-code"></i>&nbsp;Programming</h3></a></li><li><a href=https://blakeniemyjski.com/categories/review/><h3><i class="fas fa-book"></i>&nbsp;Reviews</h3></a></li><li><a href=https://blakeniemyjski.com/categories/public-speaking/><h3><i class="fas fa-comments"></i>&nbsp;Public Speaking</h3></a></li><li><a href=https://blakeniemyjski.com/about/><h3><i class="fas fa-id-card"></i>&nbsp;About</h3></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/how-to-get-notifications-when-your-mailbox-is-opened/>How-to get notifications when your mailbox is opened</a></h3><time class=published datetime=2020-12-17>December 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/disturbing-trends-in-smart-home-products-and-services/>Disturbing trends in smart home products and services</a></h3><time class=published datetime=2020-12-02>December 2, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/>Securing smart home devices with ESPHome and Home Assistant</a></h3><time class=published datetime=2020-10-17>October 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/building-and-maintaining-a-smart-home-presentation/>Building and maintaining a smart home presentation</a></h3><time class=published datetime=2020-08-25>August 25, 2020</time></header></article><a href=/categories/ class=button>View more posts</a></div></section></section><section id=share-menu><section id=social-share-nav><ul class=links><header><h3>Share this post <i class="fas fa-smile"></i></h3></header><li><a href="//twitter.com/share?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&text=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED&via=blaken" target=_blank rel=noopener class="share-btn twitter" aria-label="Share To Twitter"><i class="fab fa-twitter"></i><p>Twitter</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f" target=_blank rel=noopener class="share-btn facebook" aria-label="Share To Facebook"><i class="fab fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&title=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED" target=_blank rel=noopener class="share-btn reddit" aria-label="Share To Reddit"><i class="fab fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&title=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED" target=_blank rel=noopener class="share-btn linkedin" aria-label="Share To LinkedIn"><i class="fab fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f" target=_blank rel=noopener class="share-btn email" aria-label="Share To Email"><i class="fas fa-envelope"></i><p>Email</p></a></li></ul></section></section><div id=main><article class=post><header><div class=title><h1><a href=https://blakeniemyjski.com/blog/hello-home-automation-how-to-detect-battery-levels-with-node-red/>Hello Home Automation, How-to detect battery levels with Node-RED</a></h1></div><div class=meta><time class=published datetime=2020-02-03>February 3, 2020</time>
<span class=author></span><p>3 minute read</p></div></header><section id=social-share><ul class=icons><li><a href="//twitter.com/share?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&text=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED&via=blaken" target=_blank rel=noopener class="share-btn twitter" aria-label="Share To Twitter"><i class="fab fa-twitter"></i><p>Twitter</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f" target=_blank rel=noopener class="share-btn facebook" aria-label="Share To Facebook"><i class="fab fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&title=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED" target=_blank rel=noopener class="share-btn reddit" aria-label="Share To Reddit"><i class="fab fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f&title=Hello%20Home%20Automation%2c%20How-to%20detect%20battery%20levels%20with%20Node-RED" target=_blank rel=noopener class="share-btn linkedin" aria-label="Share To LinkedIn"><i class="fab fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fblakeniemyjski.com%2fblog%2fhello-home-automation-how-to-detect-battery-levels-with-node-red%2f" target=_blank rel=noopener class="share-btn email" aria-label="Share To Email"><i class="fas fa-envelope"></i><p>Email</p></a></li></ul></section><div id=content><p>I&rsquo;ve decided to start off 2020 by converting my blog to <a href=https://gohugo.io>Hugo</a>
and start blogging again! This is my first of many posts on home automation!
This post is going to cover generically detecting battery levels with
<a href=https://www.home-assistant.io>Home Assistant</a> and <a href=https://nodered.org>Node-RED</a>.</p><blockquote><p>TLDR: Use the <a href=https://nodered.org/docs/user-guide/nodes#function>Function node</a>
defined in the <a href=https://gist.github.com/niemyjski/afc28ed47ae137fe5e245b245fd6c910>Node-RED snippet here</a>
to properly handle all the edge cases.</p></blockquote><p>I decided to share my experiences based on seeing what others were doing in this
<a href=https://www.reddit.com/r/homeassistant/comments/emvk9y/how_do_you_monitor_sensor_battery_levels_looking/>thread</a>.
For the most part, I saw users not accounting for edge cases or the <a href=https://nodered.org/docs/user-guide/nodes#switch>Switch node</a>
wasn&rsquo;t going to work how they thought it was going to work.</p><p>Two of the main gotchas I&rsquo;ve come across with device types that report battery
state:</p><ul><li>storing it in different locations (<code>msg.state</code>, <code>msg.payload.attributes["Battery Level"]</code>, etc.)</li><li>differing values/data types (<code>off</code>, <code>Charging</code>, <code>"100"</code>, <code>100</code>)</li></ul><p>This really makes it difficult to use the Switch or <a href=https://nodered.org/docs/user-guide/nodes#change>Change node</a>
with conditional logic as it might not behave <a href=https://www.destroyallsoftware.com/talks/wat>how you think it does</a>.
This happened to me when I was debugging my first few attempts and getting <code>10</code>
outputted in a <code>100</code> bucket via the <code>gt</code> condition. The best way I&rsquo;ve found to
handle these scenarios is with a <a href=https://nodered.org/docs/user-guide/nodes#function>Function node</a>.</p><h2 id=home-assistant-feedback-and-edge-cases>Home Assistant Feedback and Edge Cases</h2><p>I think it may be worth opening a GitHub issue for this. It sure would be nice
if devices that can charge have their charging state normalized, battery level
state in the same spot with a last changed in attribute. Additionally it would
be nice to see something for dead batteries or if the device just hasn&rsquo;t reported
in a long time. I say this because I&rsquo;ve have many devices I know are charged
and on, but they are being reported as <code>off</code>. What do you think?</p><h3 id=examples>Examples</h3><p>Off, clearly the battery has a level and it lasts 10 years and it&rsquo;s reported in the nest app as OK.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;binary_sensor.nest_protect_battery_health&#34;</span>,<span style=color:#f92672>&#34;state&#34;</span>:<span style=color:#e6db74>&#34;off&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:{<span style=color:#f92672>&#34;friendly_name&#34;</span>:<span style=color:#e6db74>&#34;Nest Battery&#34;</span>,<span style=color:#f92672>&#34;device_class&#34;</span>:<span style=color:#e6db74>&#34;battery&#34;</span>},<span style=color:#f92672>&#34;last_changed&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:42:50.976581+00:00&#34;</span>,<span style=color:#f92672>&#34;last_updated&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:42:50.976581+00:00&#34;</span>,<span style=color:#f92672>&#34;context&#34;</span>:{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;2a2f5c1503cd44c7bb3ebd9be69a4144&#34;</span>,<span style=color:#f92672>&#34;parent_id&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;user_id&#34;</span>:<span style=color:#66d9ef>null</span>},<span style=color:#f92672>&#34;timeSinceChangedMs&#34;</span>:<span style=color:#ae81ff>2731510</span>}
</code></pre></div><p>Charging - battery level stored in attributes.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;sensor.battery_state_2&#34;</span>,<span style=color:#f92672>&#34;state&#34;</span>:<span style=color:#e6db74>&#34;Charging&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:{<span style=color:#f92672>&#34;Battery Level&#34;</span>:<span style=color:#ae81ff>52</span>,<span style=color:#f92672>&#34;friendly_name&#34;</span>:<span style=color:#e6db74>&#34;Battery State&#34;</span>,<span style=color:#f92672>&#34;icon&#34;</span>:<span style=color:#e6db74>&#34;mdi:battery-charging-40&#34;</span>,<span style=color:#f92672>&#34;device_class&#34;</span>:<span style=color:#e6db74>&#34;battery&#34;</span>},<span style=color:#f92672>&#34;last_changed&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:43:06.616903+00:00&#34;</span>,<span style=color:#f92672>&#34;last_updated&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:43:06.616903+00:00&#34;</span>,<span style=color:#f92672>&#34;context&#34;</span>:{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;a9cc54cd33cf4cf1954c4cd2f2f633a8&#34;</span>,<span style=color:#f92672>&#34;parent_id&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;user_id&#34;</span>:<span style=color:#66d9ef>null</span>},<span style=color:#f92672>&#34;timeSinceChangedMs&#34;</span>:<span style=color:#ae81ff>2715885</span>}
</code></pre></div><p>Same device as Charging example above but duplicate battery device sensor with state in the correct location.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;sensor.battery_level_2&#34;</span>,<span style=color:#f92672>&#34;state&#34;</span>:<span style=color:#e6db74>&#34;52&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:{<span style=color:#f92672>&#34;Battery State&#34;</span>:<span style=color:#e6db74>&#34;Charging&#34;</span>,<span style=color:#f92672>&#34;unit_of_measurement&#34;</span>:<span style=color:#e6db74>&#34;%&#34;</span>,<span style=color:#f92672>&#34;friendly_name&#34;</span>:<span style=color:#e6db74>&#34;Battery Level&#34;</span>,<span style=color:#f92672>&#34;icon&#34;</span>:<span style=color:#e6db74>&#34;mdi:battery-charging-40&#34;</span>,<span style=color:#f92672>&#34;device_class&#34;</span>:<span style=color:#e6db74>&#34;battery&#34;</span>},<span style=color:#f92672>&#34;last_changed&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:43:06.599389+00:00&#34;</span>,<span style=color:#f92672>&#34;last_updated&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:43:06.599389+00:00&#34;</span>,<span style=color:#f92672>&#34;context&#34;</span>:{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;60469c2964504dc4bb11cbf5a307ceb9&#34;</span>,<span style=color:#f92672>&#34;parent_id&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;user_id&#34;</span>:<span style=color:#66d9ef>null</span>},<span style=color:#f92672>&#34;timeSinceChangedMs&#34;</span>:<span style=color:#ae81ff>3766731</span>}
</code></pre></div><p>August lock reported from august integration missing information.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;binary_sensor.august_door_locked_battery_level&#34;</span>,<span style=color:#f92672>&#34;state&#34;</span>:<span style=color:#e6db74>&#34;off&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:{<span style=color:#f92672>&#34;friendly_name&#34;</span>:<span style=color:#e6db74>&#34;August Door Lock Battery Level&#34;</span>,<span style=color:#f92672>&#34;device_class&#34;</span>:<span style=color:#e6db74>&#34;battery&#34;</span>},<span style=color:#f92672>&#34;last_changed&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:42:50.892228+00:00&#34;</span>,<span style=color:#f92672>&#34;last_updated&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:42:50.892228+00:00&#34;</span>,<span style=color:#f92672>&#34;context&#34;</span>:{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;567d9c771c91440c826ed26d14187513&#34;</span>,<span style=color:#f92672>&#34;parent_id&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;user_id&#34;</span>:<span style=color:#66d9ef>null</span>},<span style=color:#f92672>&#34;timeSinceChangedMs&#34;</span>:<span style=color:#ae81ff>2731591</span>}
</code></pre></div><p>August lock as reported from Z-Wave.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;sensor.august_asl_03_smart_lock_battery_level&#34;</span>,<span style=color:#f92672>&#34;state&#34;</span>:<span style=color:#e6db74>&#34;100&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:{<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;value_index&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;value_instance&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;value_id&#34;</span>:<span style=color:#e6db74>&#34;72057594077773825&#34;</span>,<span style=color:#f92672>&#34;unit_of_measurement&#34;</span>:<span style=color:#e6db74>&#34;%&#34;</span>,<span style=color:#f92672>&#34;friendly_name&#34;</span>:<span style=color:#e6db74>&#34;August ASL-03 Smart Lock Battery Level&#34;</span>,<span style=color:#f92672>&#34;device_class&#34;</span>:<span style=color:#e6db74>&#34;battery&#34;</span>},<span style=color:#f92672>&#34;last_changed&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:47:39.195031+00:00&#34;</span>,<span style=color:#f92672>&#34;last_updated&#34;</span>:<span style=color:#e6db74>&#34;2020-01-11T11:47:39.195031+00:00&#34;</span>,<span style=color:#f92672>&#34;context&#34;</span>:{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;406c8c33527a4daf8d9b23531953d54f&#34;</span>,<span style=color:#f92672>&#34;parent_id&#34;</span>:<span style=color:#66d9ef>null</span>,<span style=color:#f92672>&#34;user_id&#34;</span>:<span style=color:#66d9ef>null</span>},<span style=color:#f92672>&#34;timeSinceChangedMs&#34;</span>:<span style=color:#ae81ff>2443740</span>}
</code></pre></div><h4 id=handling-the-edge-cases>Handling the edge cases</h4><p>The best way to handle all the edge cases above is with a <a href=https://nodered.org/docs/user-guide/nodes#function>Function node</a>.
It will be extremely tough to handle normalizing the battery level with any
other node type with out a really crazy series.</p><blockquote><p>It should be everyone&rsquo;s goal to keep automations as simple as possible. This
keeps the maintenance super low and the acceptance factor has high
as possible!</p></blockquote><p>So lets get started by creating a new Function node with <code>6</code> outputs.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// NOTE: We could probably look at the unit_of_measurement if specified to properly normalize the battery level.
</span><span style=color:#75715e>// Check for battery level as it&#39;s set when state is Charging,Not Charging,etc...
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>batteryLevelAttr</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>attributes</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>attributes</span>[<span style=color:#e6db74>&#34;Battery Level&#34;</span>];
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>isNaN(<span style=color:#a6e22e>batteryLevelAttr</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>batteryLevelAttr</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>state</span>;
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>level</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>state</span>);
<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isFinite(<span style=color:#a6e22e>level</span>)) {
    <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>msg</span>];
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span>) {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>msg</span>];
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>25</span>) {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>msg</span>];
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>50</span>) {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>msg</span>];
} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>level</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>75</span>) {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>msg</span>];
} <span style=color:#66d9ef>else</span> {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>msg</span>];
}
</code></pre></div><p>By creating 6 outputs and outputting the message to the desired output, we can
wire up routines to fire on only the battery level ranges we care about
(e.g., 0-10%, 10-25%, etc.)!</p><h2 id=bringing-it-all-together>Bringing it all together</h2><p>I&rsquo;ve created a Node-RED flow to get every device that supports battery levels
and output them to a Debug Node using the above Function Node.</p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/node-red-home-assistant-battery-level-flow.png alt="Node-RED Home Assistant Battery Level Flow"></p><p>You can grab the complete <a href=https://gist.github.com/niemyjski/afc28ed47ae137fe5e245b245fd6c910>Node-RED snippet here</a>.</p></div><footer><ul class=stats><li class=categories><ul><i class="fas fa-folder"></i><li><a class=article-category-link href=https://blakeniemyjski.com/categories/home-automation>Home Automation</a></li></ul></li><li class=tags><ul><i class="fas fa-tags"></i><li><a class=article-category-link href=https://blakeniemyjski.com/tags/home-assistant>Home Assistant</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/z-wave>Z-Wave</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/battery>Battery</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/device-state>Device State</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/node-red>Node-RED</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/automation>Automation</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/smart-home>Smart Home</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/binary_sensor>binary_sensor</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/sensor>sensor</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/acceptance-factor>Acceptance Factor</a></li></ul></li></ul></footer><div id=mailing-list><h3>Join the mailing list</h3>Get notified of new posts and related content to your inbox. I will never sell
you anything and I will NEVER sell your email address.<form class=email-form name=newsletter method=post data-netlify=true netlify-honeypot=bot-field><div hidden aria-hidden=true><label>Don't fill this out if you're human:
<input name=bot-field></label></div><label for=email>Your email address</label><div class=email-container><input type=email name=email placeholder=Email id=email required>
<button name=submit class=button type=submit id=subscribe>Subscribe</button></div></form></div></article><article class=post><div class=disqus></div><script>(function(){var a='niemyjski';window.disqusLoaderSettings={element:'.disqus',options:{scriptUrl:'//'+a+'.disqus.com/embed.js',disqusConfig:function(){this.page.url="https://blakeniemyjski.com/blog/hello-home-automation-how-to-detect-battery-levels-with-node-red/",this.page.identifier="https://blakeniemyjski.com/blog/hello-home-automation-how-to-detect-battery-levels-with-node-red/"}}}})()</script></article><ul class="actions pagination"><li><a href=https://blakeniemyjski.com/blog/speaking-at-bam/ class="button big previous">Speaking at BAM</a></li><li><a href=https://blakeniemyjski.com/blog/thinking-about-smart-home-power-usage/ class="button big next">Thinking about smart home power usage</a></li></ul></div><section id=sidebar><section id=intro><a href=https://blakeniemyjski.com/><img src=https://blakeniemyjski.com/img/logo.jpeg class=intro-circle width=250 alt="Blake Niemyjski"></a><header><h2>Blake Niemyjski</h2><p>Passionate about building software</p></header><ul class=icons><li><a href=https://blakeniemyjski.com/index.xml type=application/rss+xml target=_blank title=RSS><i class="fas fa-rss"></i></a></li><li><a href=//github.com/niemyjski target=_blank title=GitHub><i class="fab fa-github"></i></a></li><li><a href=//stackoverflow.com/users/199701 target=_blank title="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li><li><a href=//linkedin.com/in/niemyjski target=_blank title=LinkedIn><i class="fab fa-linkedin"></i></a></li><li><a href=//reddit.com/user/bniemyjski target=_blank title=Reddit><i class="fab fa-reddit"></i></a></li><li><a href=//youtube.com/bniemyjski target=_blank title=YouTube><i class="fab fa-youtube"></i></a></li><li><a href=//instagram.com/blake.niemyjski target=_blank title=Instagram><i class="fab fa-instagram"></i></a></li><li><a href=//twitter.com/blaken target=_blank title=Twitter><i class="fab fa-twitter"></i></a></li><li><a href=mailto:bniemyjski@gmail.com title=Email><i class="fas fa-envelope"></i></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><div class=posts-container><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/how-to-get-notifications-when-your-mailbox-is-opened/>How-to get notifications when your mailbox is opened</a></h3><time class=published datetime=2020-12-17>December 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/disturbing-trends-in-smart-home-products-and-services/>Disturbing trends in smart home products and services</a></h3><time class=published datetime=2020-12-02>December 2, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/>Securing smart home devices with ESPHome and Home Assistant</a></h3><time class=published datetime=2020-10-17>October 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/building-and-maintaining-a-smart-home-presentation/>Building and maintaining a smart home presentation</a></h3><time class=published datetime=2020-08-25>August 25, 2020</time></header></article></div><a href=/categories/ class=button>View more posts</a></div></section><section id=mini-bio><h3>About</h3><p>Blake Niemyjski is a full time open source software architect and private pilot. Since the late 90's, Blake's curiosity has been focused around developing software that helps the masses. As a hobbyist developer turned student and professional, Blake's passion is to further his knowledge and create technologies for the future.</p><a href=https://blakeniemyjski.com/about/ class=button>Learn More About Me</a></section><section id=footer><p class=copyright>&copy; 2020
Blake Niemyjski
.
Powered by <a href=//gohugo.io target=_blank rel=noreferrer>Hugo</a></p></section></section></div><a id=back-to-top href=# class="fas fa-arrow-up fa-border fa-2x"></a><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js></script><script defer src=https://use.fontawesome.com/releases/v5.13.0/js/all.js></script><script defer src=https://blakeniemyjski.com/js/util.js></script><script defer src=https://blakeniemyjski.com/js/main.js></script><script defer src=https://blakeniemyjski.com/js/backToTop.js></script><script defer src=https://blakeniemyjski.com/js/disqusLoader.js></script><script defer src=https://blakeniemyjski.com/js/mailing-list.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/highlight.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/vbnet.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/dockerfile.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/dos.min.js></script><script defer src=https://blakeniemyjski.com/js/init-highlight.js></script></body></html>