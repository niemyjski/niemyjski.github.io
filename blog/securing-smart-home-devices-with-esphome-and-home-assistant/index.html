<!doctype html><html lang=en><head><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://use.fontawesome.com crossorigin><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=preconnect href=https://www.google-analytics.com crossorigin><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blakeniemyjski.com\/"},"articleSection":"blog","name":"Securing smart home devices with ESPHome and Home Assistant","headline":"Securing smart home devices with ESPHome and Home Assistant","description":"When I first came across the ESPHome project a year or so ago. I thought it was interesting and something that I would use if I was building a smart device from scratch. I thought of all the things I could do, but I didn\u0026rsquo;t really like the idea of all the maintenance I could foresee.\n ESPHome is a system to control your ESP8266\/ESP32 by simple yet powerful configuration files and control them remotely through Home Automation systems.","inLanguage":"en","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"17170","datePublished":"2020-10-17 09:12:00 -0500 -0500","dateModified":"2020-10-17 09:12:00 -0500 -0500","url":"https:\/\/blakeniemyjski.com\/blog\/securing-smart-home-devices-with-esphome-and-home-assistant\/","wordCount":"1853","keywords":["Home Assistant","Smart Home","ESPHome","ESP8266","ESP32","Gosund","Security","Open Source","tuya-convert","Tuya","Raspberry Pi","SSH","Secrets","Firmware","Over-the-air","Blog"]}</script><title>Securing smart home devices with ESPHome and Home Assistant</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.81.0"><meta name=description content="Blake Niemyjski"><meta name=twitter:card content="summary"><meta name=twitter:title content="Securing smart home devices with ESPHome and Home Assistant"><meta name=twitter:description content="When I first came across the ESPHome project a year or so ago. I thought it was interesting and something that I would use if I was building a smart device from scratch. I thought of all the things I could do, but I didn&rsquo;t really like the idea of all the maintenance I could foresee.
 ESPHome is a system to control your ESP8266/ESP32 by simple yet powerful configuration files and control them remotely through Home Automation systems."><meta name=twitter:site content="@blaken"><meta property="og:title" content="Securing smart home devices with ESPHome and Home Assistant"><meta property="og:description" content="When I first came across the ESPHome project a year or so ago. I thought it was interesting and something that I would use if I was building a smart device from scratch. I thought of all the things I could do, but I didn&rsquo;t really like the idea of all the maintenance I could foresee.
 ESPHome is a system to control your ESP8266/ESP32 by simple yet powerful configuration files and control them remotely through Home Automation systems."><meta property="og:type" content="article"><meta property="og:url" content="https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-10-17T09:12:00-05:00"><meta property="article:modified_time" content="2020-10-17T09:12:00-05:00"><meta property="og:image" content="https://blakeniemyjski.com//images/logo.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="512"><meta property="og:image:height" content="512"><meta itemprop=name content="Securing smart home devices with ESPHome and Home Assistant"><meta itemprop=description content="When I first came across the ESPHome project a year or so ago. I thought it was interesting and something that I would use if I was building a smart device from scratch. I thought of all the things I could do, but I didn&rsquo;t really like the idea of all the maintenance I could foresee.
 ESPHome is a system to control your ESP8266/ESP32 by simple yet powerful configuration files and control them remotely through Home Automation systems."><meta itemprop=datePublished content="2020-10-17T09:12:00-05:00"><meta itemprop=dateModified content="2020-10-17T09:12:00-05:00"><meta itemprop=wordCount content="1853"><meta itemprop=keywords content="Home Assistant,Smart Home,ESPHome,ESP8266,ESP32,Gosund,Security,Open Source,tuya-convert,Tuya,Raspberry Pi,SSH,Secrets,Firmware,Over-the-air,"><link rel=preload as=style href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700&display=swap"></noscript><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css><link rel=stylesheet href=https://blakeniemyjski.com/css/main.css><link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/styles/vs.min.css rel=stylesheet type=text/css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-3422587-1','auto'),ga('send','pageview'))</script></head><body><div id=wrapper><header id=header><h1><a href=https://blakeniemyjski.com/>blog</a></h1><nav class=links><ul><li><a href=https://blakeniemyjski.com/><i class="fas fa-home"></i>&nbsp;Home</a></li><li><a href=https://blakeniemyjski.com/categories/home-automation/><i class="fas fa-magic"></i>&nbsp;Home Automation</a></li><li><a href=https://blakeniemyjski.com/categories/programming/><i class="fas fa-code"></i>&nbsp;Programming</a></li><li><a href=https://blakeniemyjski.com/categories/review/><i class="fas fa-book"></i>&nbsp;Reviews</a></li><li><a href=https://blakeniemyjski.com/categories/public-speaking/><i class="fas fa-comments"></i>&nbsp;Public Speaking</a></li><li><a href=https://blakeniemyjski.com/about/><i class="fas fa-id-card"></i>&nbsp;About</a></li></ul></nav><nav class=main><ul><li id=share-nav class=share-menu style=display:none><a class=fa-share-alt href=#share-menu>Share</a></li><li class=search><a class=fa-search href=#search>Search</a><form id=search method=get action=//google.com/search><input type=text name=q placeholder=Search aria-label=Search>
<input type=hidden name=as_sitesearch value=https://blakeniemyjski.com/></form></li><li class=menu><a class=fa-bars href=#menu>Menu</a></li></ul></nav></header><section id=menu><section><form class=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=https://blakeniemyjski.com/></form></section><section><ul class=links><li><a href=https://blakeniemyjski.com/><h3><i class="fas fa-home"></i>&nbsp;Home</h3></a></li><li><a href=https://blakeniemyjski.com/categories/home-automation/><h3><i class="fas fa-magic"></i>&nbsp;Home Automation</h3></a></li><li><a href=https://blakeniemyjski.com/categories/programming/><h3><i class="fas fa-code"></i>&nbsp;Programming</h3></a></li><li><a href=https://blakeniemyjski.com/categories/review/><h3><i class="fas fa-book"></i>&nbsp;Reviews</h3></a></li><li><a href=https://blakeniemyjski.com/categories/public-speaking/><h3><i class="fas fa-comments"></i>&nbsp;Public Speaking</h3></a></li><li><a href=https://blakeniemyjski.com/about/><h3><i class="fas fa-id-card"></i>&nbsp;About</h3></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/how-to-get-notifications-when-your-mailbox-is-opened/>How-to get notifications when your mailbox is opened</a></h3><time class=published datetime=2020-12-17>December 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/disturbing-trends-in-smart-home-products-and-services/>Disturbing trends in smart home products and services</a></h3><time class=published datetime=2020-12-02>December 2, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/>Securing smart home devices with ESPHome and Home Assistant</a></h3><time class=published datetime=2020-10-17>October 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/building-and-maintaining-a-smart-home-presentation/>Building and maintaining a smart home presentation</a></h3><time class=published datetime=2020-08-25>August 25, 2020</time></header></article><a href=/categories/ class=button>View more posts</a></div></section></section><section id=share-menu><section id=social-share-nav><ul class=links><header><h3>Share this post <i class="fas fa-smile"></i></h3></header><li><a href="//twitter.com/share?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&text=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant&via=blaken" target=_blank rel=noopener class="share-btn twitter" aria-label="Share To Twitter"><i class="fab fa-twitter"></i><p>Twitter</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f" target=_blank rel=noopener class="share-btn facebook" aria-label="Share To Facebook"><i class="fab fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&title=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant" target=_blank rel=noopener class="share-btn reddit" aria-label="Share To Reddit"><i class="fab fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&title=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant" target=_blank rel=noopener class="share-btn linkedin" aria-label="Share To LinkedIn"><i class="fab fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f" target=_blank rel=noopener class="share-btn email" aria-label="Share To Email"><i class="fas fa-envelope"></i><p>Email</p></a></li></ul></section></section><div id=main><article class=post><header><div class=title><h1><a href=https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/>Securing smart home devices with ESPHome and Home Assistant</a></h1></div><div class=meta><time class=published datetime=2020-10-17>October 17, 2020</time>
<span class=author></span><p>9 minute read</p></div></header><section id=social-share><ul class=icons><li><a href="//twitter.com/share?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&text=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant&via=blaken" target=_blank rel=noopener class="share-btn twitter" aria-label="Share To Twitter"><i class="fab fa-twitter"></i><p>Twitter</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f" target=_blank rel=noopener class="share-btn facebook" aria-label="Share To Facebook"><i class="fab fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&title=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant" target=_blank rel=noopener class="share-btn reddit" aria-label="Share To Reddit"><i class="fab fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f&title=Securing%20smart%20home%20devices%20with%20ESPHome%20and%20Home%20Assistant" target=_blank rel=noopener class="share-btn linkedin" aria-label="Share To LinkedIn"><i class="fab fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="mailto:?subject=Check out this post by &body=https%3a%2f%2fblakeniemyjski.com%2fblog%2fsecuring-smart-home-devices-with-esphome-and-home-assistant%2f" target=_blank rel=noopener class="share-btn email" aria-label="Share To Email"><i class="fas fa-envelope"></i><p>Email</p></a></li></ul></section><div id=content><p>When I first came across the <a href=https://esphome.io>ESPHome</a> project a year or so
ago. I thought it was interesting and something that I would use if I was
building a smart device from scratch. I thought of all the things I could do,
but I didn&rsquo;t really like the idea of all the maintenance I could foresee.</p><blockquote><p>ESPHome is a system to control your ESP8266/ESP32 by simple yet powerful
configuration files and control them remotely through Home Automation systems.</p></blockquote><p>It took some persuasion by <a href=https://www.architectryan.com>Ryan Hoffman</a>, who
has been building a bunch of custom made ESPHome projects to show me what is
possible with ESPHome. I&rsquo;m starting to kick myself in the butt (better now than
never) that I didn&rsquo;t take time to check this project out sooner. I&rsquo;ve since
purchased multiple ESPHome devices such as the
<a href="https://www.amazon.com/gp/product/B079MFTYMV?tag=niemyjski-20">Gosund Mini WiFi Outlet</a>
and <a href="https://www.amazon.com/gp/product/B0718T232Z?tag=niemyjski-20">HiLetgo ESP-WROOM-32 ESP32</a>.
The next device that I think will work great for holiday lights is the
<a href="https://www.amazon.com/Gosund-Protector-Controlled-Individually-Required/dp/B07P65GJS1?tag=niemyjski-20">Gosund Smart Power Strip</a>.</p><p>I think one really huge benefit that mostly goes unnoticed for for a larger part
of the smart home community is all the retail devices running ESPHome. This
means that you can buy devices you might not trust on your networks due to them
being from a company you&rsquo;ve never heard from and completely flashing the
firmware to something you&rsquo;ve created. Yes, there still could be software embedded
onto different chips but it&rsquo;s unlikely.</p><p>In the sections below I will cover installing ESPHome to work with
<a href=https://www.home-assistant.io>Home Assistant</a>, flashing a device, and
adding the device to Home Assistant.</p><blockquote><p>ESPHome can use mqtt so you can use it without Home Assistant too!</p></blockquote><h2 id=benefits>Benefits</h2><p>Here are some of the benefits I&rsquo;ve noticed since using some of my first devices.</p><ul><li>Open Source (Audited)</li><li>Easy to manage with Over-the-air (OTA) updates</li><li>Flash any ESPHome device (including retail devices)</li><li>Cheap</li><li>Rock Solid</li><li>Rich local automation support right inside the firmware that can use Home Assistant states</li></ul><h2 id=installing-the-esphome-add-on>Installing the ESPHome add-on</h2><p>Lets install the <a href=https://github.com/esphome/hassio>ESPHome add-on</a> from
<a href=https://github.com/hassio-addons/repository>Home Assistant Community Add-ons</a>
repository. This allows us to run ESPHome locally and have our devices integrate
automatically with Home Assistant by taking advantage of all the awesome
community work that&rsquo;s been done. Behind the scenes the add-on uses auto discovery
to expose configured devices to Home Assistant automatically!</p><blockquote><p>There is an <a href=https://esphome.io/guides/getting_started_hassio.html>official getting started</a>
guide, but I found it slightly confusing and the steps below straight forward!</p></blockquote><ol><li>Navigate to <a href=http://homeassistant.local:8123/hassio/store>http://homeassistant.local:8123/hassio/store</a>.</li><li>Click on the option menu in the upper right and select <code>Repositories</code>.</li><li>Enter <code>https://github.com/hassio-addons/repository</code> and then click the <code>Add</code> button.</li><li>Click the close button to close the <code>Manage add-on repositories</code> dialog.</li><li>Select the <code>ESPHome</code> add-on or access via the url <a href=http://homeassistant.local:8123/hassio/addon/a0d7b954_esphome/info>http://homeassistant.local:8123/hassio/addon/a0d7b954_esphome/info</a>.</li><li>Click the <code>Install</code> button.</li><li>Toggle the <code>Show in sidebar</code> option for ease of use (Optional)</li><li>Finally, click the <code>Start</code> button.</li></ol><p>ESPHome should now be running as an add-on and you can access the ESPHome web ui
on via the sidebar or directly using
<a href=http://homeassistant.local:8123/hassio/ingress/a0d7b954_esphome>http://homeassistant.local:8123/hassio/ingress/a0d7b954_esphome</a>.</p><h2 id=esphome-devices>ESPHome devices</h2><p>A huge misconception I had with ESPHome was that I had to build all my devices.
It wasn&rsquo;t until recently that it was pointed out to me that there are a ton of
cheap consumer devices from brands you&rsquo;ve never heard of, and more than likely
never have trusted to ever connect to your IoT/NoT network. This is super
awesome game changer! You can build your own device firmware, flash the
manufactures device knowing exactly what the device is doing, and then reflash
it Over-the-air (OTA) via ESPHome with a few clicks! This really saves on the
maintenance as well as having more trust for the security of the device.</p><p>My first ESPHome compatible device was the <a href="https://www.amazon.com/gp/product/B079MFTYMV?tag=niemyjski-20">Gosund Mini WiFi Outlet</a></p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-gosund-smart-plug-695.png alt="Gosund Mini WiFi Outlet"></p><p>I&rsquo;d recommend checking out one of the following links to find retail devices
that work with ESPHome</p><ul><li><a href="https://www.amazon.com/s?k=esphome&tag=niemyjski-20">Amazon ESPHome</a></li><li><a href="https://www.amazon.com/s?k=smart+2.4GHz+WiFi+Only&tag=niemyjski-20">Amazon 2.4GHz WiFi Only</a> (<code>2.4GHz WiFi Only</code> is a really good indication a device is running ESPHome, but double check)</li><li><a href=https://esphome-configs.io/devices/>ESPHome Configs</a></li><li><a href=https://templates.blakadder.com/us.html>TASMOTA devices</a> (An ESPHome alternative)</li></ul><p>Once you have a device we need to flash it, in order to flash it we need to
configure some software and hardware.</p><blockquote><p>Please note you may BRICK your device by flashing it or break the terms of
any device/licenses.</p></blockquote><h3 id=hardware-requirements>Hardware Requirements</h3><p>I used a spare <a href="https://www.amazon.com/ELEMENT-Element14-Raspberry-Pi-Motherboard/dp/B07P4LSDYV?tag=niemyjski-20">Raspberry Pi 3 B+</a>
that I had laying around, otherwise any Pi that supports Wifi will work like the
<a href="https://www.amazon.com/CanaKit-Raspberry-4GB-Starter-Kit/dp/B07V5JTMV9?tag=niemyjski-20">Raspberry Pi 4 Model B</a>.</p><p>Please note that you can use any free hardware granted you have an unused wifi
adaptor. You just need to meet and it meets the requirements of
<a href=https://github.com/ct-Open-Source/tuya-convert>tuya-convert</a>.</p><h3 id=installing-tuya-convert-on-a-pi>Installing tuya-convert on a Pi</h3><p>In this section I&rsquo;ll be configuring the Raspberry Pi to run the flashing
software <a href=https://github.com/ct-Open-Source/tuya-convert>tuya-convert</a>. Please
follow the steps below to get <code>tuya-convert</code> up and running.</p><ol><li>Download <a href=https://www.raspberrypi.org/downloads/raspberry-pi-os/><code>Raspberry Pi OS</code></a></li><li>Install the <a href=https://www.raspberrypi.org/downloads/><code>Raspberry Pi Imager</code></a></li><li>Insert a 2GB or bigger <a href="https://www.amazon.com/dp/B07B9KTLJZ?tag=niemyjski-20">SD Card</a> into your computer.</li><li>Launch the <code>Raspberry Pi Imager</code> and image the SD Card with the downloaded <code>Raspberry Pi OS</code>.</li><li>Remount the imaged SD Card.</li><li>Navigate to the root of the SD Card and create a file called <code>ssh</code> (e.g., <code>touch ssh</code>).
This will allow you to <code>SSH</code> into the Pi in a headless manner.</li><li>Eject the SD Card and insert into your Pi.</li><li>Ensure you have ethernet plugged into your Pi</li><li>Power on the Pi and wait.</li><li><code>SSH</code> into the Pi <code>ssh pi@10.0.0.100</code> (you might need to figure out the ip using your router).</li><li>Enter in the default password of <code>raspberry</code>.</li><li>Install git using <code>sudo apt-get install git</code> and enter <code>yes</code> when prompted.</li><li>Install <code>tuya-convert</code> by cloning it with <code>git clone https://github.com/ct-Open-Source/tuya-convert.git</code>.</li><li>Navigate to the <code>tuya-convert</code> directory using <code>cd tuya-convert</code>.</li><li>Install the dependencies by running <code>./install_prereq.sh</code>.</li></ol><p>Now that <code>tuya-convert</code> is installed, we need to switch gears and build our
custom firmware for our device.</p><h3 id=building-the-esphome-firmware>Building the ESPHome Firmware</h3><p>Now it&rsquo;s time to jump back into the ESPHome addon we configured earlier. You
can access the ESPHome web ui from the sidebar or directly using
<a href=http://homeassistant.local:8123/hassio/ingress/a0d7b954_esphome>http://homeassistant.local:8123/hassio/ingress/a0d7b954_esphome</a>.</p><p>I&rsquo;ll be building the firmware for the
<a href="https://www.amazon.com/gp/product/B079MFTYMV?tag=niemyjski-20">Gosund Mini WiFi Outlet</a>,
if you are using a different ESPHome device, you will need to tweak the
following steps slightly.</p><h4 id=create-new-esphome-device>Create new ESPHome device</h4><ol><li>Click the Add button in the lower right hand side to bring up a
<code>Create New Node</code> modal.</li><li>Enter in the new Node Name and click <code>Next</code>. I entered <code>gosund_wp3_02</code> as this is my second device.</li><li>Select the device type and and click <code>Next</code>. I selected <code>Generic ESP8266</code>.</li><li>Enter in your WiFi network information or some garbage text (we will configure them via secrets in a little bit) and click <code>Next</code></li></ol><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-dashboard-status-695.png alt="ESPHome Dashboard Status"></p><p>It&rsquo;s worth pointing out that you may see a red line at the top of your device.
This means that your device is offline and hasn&rsquo;t communicated with ESPHome. If
it is green, that means the device is online.</p><p>Also, if you look closely at this point to your Home Assistant installation,
you will see that an <code>esphome</code> folder was created with a yaml file and folder
that matches your Node Name! This allows you to make edits in your editor of
choice and also commit these to source control!</p><h4 id=edit-esphome-secrets>Edit ESPHome Secrets</h4><p>We will configure some secrets that will be merged into the firmware
configuration. This works much like the lovelace secrets work! You can do this
by clicking on the options menu in the upper right and selecting <code>Secrets Editor</code>.</p><blockquote><p>It&rsquo;s also worth pointing out that you can have ESPHome use your
<a href=https://esphome.io/guides/faq.html#how-do-i-use-my-home-assistant-secrets-yaml>Home Assistant secrets.yaml file</a>!</p></blockquote><p>The firmware I will be using uses the following secrets. This may be different
for the firmware you are using.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>wifi_ssid</span>: <span style=color:#e6db74>&#34;my_secret_network_name&#34;</span>
<span style=color:#f92672>wifi_password</span>: <span style=color:#e6db74>&#34;my_secret_network_password&#34;</span>
<span style=color:#f92672>wifi_fallback_password</span>: <span style=color:#e6db74>&#34;my_secret_network_password&#34;</span>
<span style=color:#f92672>gosund_ota_password</span>: <span style=color:#e6db74>&#34;&#34;</span>
</code></pre></div><p>After you&rsquo;ve configured the secrets hit <code>Save</code> and <code>Close</code> buttons respectively.</p><h4 id=edit-esphome-device-firmware>Edit ESPHome Device Firmware</h4><p>Now that the secrets are configured lets click on the <code>Edit</code> button of the new
device we created inside of ESPHome. I&rsquo;m going to copy the
<a href=https://github.com/jonathanadams/esphome-configs/blob/7eb19efa29cc772f400df9ad582fe3a0be378b16/_devices/Gosund-WP3/Gosund-WP3.md>firmware yaml</a>
from github into this editor and click <code>Save</code> and <code>Close</code> buttons respectively.</p><blockquote><p>This firmware supports <code>substitutions</code>, which allows you to make variable
replacements to the firmware easily. I use <code>substitutions</code> to change the
<code>device_name</code> or <code>friendly_name</code>.</p></blockquote><p>Next, click on the ESPHome Device options in the upper right of we just edited
and select <code>Compile</code>. This will open a modal and start compiling the firmware.
Once we the firmware is compiled there will be an option to <code>Download Binary</code>.
Click this to save the firmware to your machine.</p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-compiling-firmware-wp3-02-yaml-736.png alt="ESPHome Compile Firmware"></p><h4 id=uploading-the-firmware-to-the-pi>Uploading the firmware to the Pi</h4><p>The next step could be the most trickiest step of them all (if you are running
Windows), which is getting the firmware onto the pi. We need to copy the file
from the downloads folder to the <code>/home/pi/tuya-convert/files</code> folder.</p><p>This can be done by navigating to the downloads folder in your terminal and
entering: <code>scp gosund_wp3_02.bin pi@10.0.0.100:/home/pi/tuya-convert/files</code> and
enter in the default password of <code>raspberry</code> when asked.</p><h4 id=flashing>Flashing&mldr;</h4><p>Don&rsquo;t forget to plug in our device and hit the pairing button to enter setup
mode!</p><p>After the device is in setup mode, switch back over to the Pi that we were
connected to earlier via SSH and run the <code>./start_flash.sh</code> script</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>pi@raspberrypi:/home/pi/tuya-convert# ./start_flash.sh
</code></pre></div><p>You may have to enter <code>y</code>, to terminate some running service (e.g., <code>dnsmasq</code>,
<code>mosquitto</code>) when prompted. After a while you will be presented with several
options</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd>Available options:
  0) return to stock
  1) flash gosund_wp3_02.bin
  q) quit; do nothing
</code></pre></div><blockquote><p>Double check yourself at this step as you don&rsquo;t want to flash the wrong
firmware!</p></blockquote><p>You will want to flash it with the binary you uploaded in the previous step!
Enter in the number of your firmware and follow any remaining prompts. After
the device reboots it will now show up in ESPHome highlighted in green and
you&rsquo;ll be asked to configure it in Home Assistant!</p><h5 id=locked-firmware>locked firmware</h5><p>It appears there is a
<a href=https://github.com/ct-Open-Source/tuya-convert/wiki/Collaboration-document-for-PSK-Identity-02>new firmware</a>
on some Tuya devices that is preventing flashing causing vendor lock in to
unknown third party services. There are two workarounds,
<a href=https://siytek.com/how-to-flash-esp-devices-with-tasmota-using-raspberry-pi/#Soldering_the_wires>one requires soldering</a>
and the other solution <a href="https://www.youtube.com/watch?v=imKZbhJ8lvU">requires a 3D Printer</a></p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/imKZbhJ8lvU style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h3 id=adding-the-flashed-device-to-home-assistant>Adding the flashed device to home assistant</h3><p>The device will be automatically discovered by the ESPHome add-on and you&rsquo;ll
be asked to configure the device.</p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-gosund-wp3-02-discovered-299.png alt="ESPHome Device Discovered"></p><p>Once you configure the device you&rsquo;ll have several device entities as shown below.</p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-gosund-wp3-02-entities-341.png alt="ESPHome Device Entities"></p><p>It&rsquo;s worth noting that you can use the physical button and the relay independently.
This is possible because you have full control over how your devices operate
when building your firmware!</p><h3 id=updating-device-firmware>Updating Device Firmware</h3><p>If you need to update the device firmware later, it is a simple process. All
you need to do is navigate to the device in the ESPHome Dashboard and click
<code>Edit</code>. After you&rsquo;ve made your changes, click the <code>Upload</code> button.</p><p><img src=https://blakeniemyjski.com/img/blog/home-automation/esphome-gosund-wp3-01-update-1150.png alt="ESPHome Device Firmware Update"></p><p>This will compile and upload the firmware to the device Over-the-air (OTA) and
then start tailing the device logs. Just click the <code>Stop</code> button after the
firmware is updated to close the modal.</p><h2 id=final-thoughts>Final Thoughts</h2><p>I&rsquo;ve really enjoyed using ESPHome so far. The overall ease of use and seamless
integration into Home Assistant feels really polished. I&rsquo;ve also noticed that
all of my ESPHome devices are really stable and rock solid! I&rsquo;ll be buying more
ESPHome devices for my projects.</p></div><footer><ul class=stats><li class=categories><ul><i class="fas fa-folder"></i><li><a class=article-category-link href=https://blakeniemyjski.com/categories/home-assistant>Home Assistant</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/home-automation>Home Automation</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/hardware>Hardware</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/smart-home>Smart Home</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/esphome>ESPHome</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/security>Security</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/categories/open-source>Open Source</a></li></ul></li><li class=tags><ul><i class="fas fa-tags"></i><li><a class=article-category-link href=https://blakeniemyjski.com/tags/home-assistant>Home Assistant</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/smart-home>Smart Home</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/esphome>ESPHome</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/esp8266>ESP8266</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/esp32>ESP32</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/gosund>Gosund</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/security>Security</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/open-source>Open Source</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/tuya-convert>tuya-convert</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/tuya>Tuya</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/raspberry-pi>Raspberry Pi</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/ssh>SSH</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/secrets>Secrets</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/firmware>Firmware</a></li><li><a class=article-category-link href=https://blakeniemyjski.com/tags/over-the-air>Over-the-air</a></li></ul></li></ul></footer><div id=mailing-list><h3>Join the mailing list</h3>Get notified of new posts and related content to your inbox. I will never sell
you anything and I will NEVER sell your email address.<form class=email-form name=newsletter method=post data-netlify=true netlify-honeypot=bot-field><div hidden aria-hidden=true><label>Don't fill this out if you're human:
<input name=bot-field></label></div><label for=email>Your email address</label><div class=email-container><input type=email name=email placeholder=Email id=email required>
<button name=submit class=button type=submit id=subscribe>Subscribe</button></div></form></div></article><article class=post><div class=disqus></div><script>(function(){var a='niemyjski';window.disqusLoaderSettings={element:'.disqus',options:{scriptUrl:'//'+a+'.disqus.com/embed.js',disqusConfig:function(){this.page.url="https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/",this.page.identifier="https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/"}}}})()</script></article><ul class="actions pagination"><li><a href=https://blakeniemyjski.com/blog/building-and-maintaining-a-smart-home-presentation/ class="button big previous">Building and maintaining a smart home presentation</a></li><li><a href=https://blakeniemyjski.com/blog/disturbing-trends-in-smart-home-products-and-services/ class="button big next">Disturbing trends in smart home products and services</a></li></ul></div><section id=sidebar><section id=intro><a href=https://blakeniemyjski.com/><img src=https://blakeniemyjski.com/img/logo.jpeg class=intro-circle width=250 alt="Blake Niemyjski"></a><header><h2>Blake Niemyjski</h2><p>Passionate about building software</p></header><ul class=icons><li><a href=https://blakeniemyjski.com/index.xml type=application/rss+xml target=_blank title=RSS><i class="fas fa-rss"></i></a></li><li><a href=//github.com/niemyjski target=_blank title=GitHub><i class="fab fa-github"></i></a></li><li><a href=//stackoverflow.com/users/199701 target=_blank title="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li><li><a href=//linkedin.com/in/niemyjski target=_blank title=LinkedIn><i class="fab fa-linkedin"></i></a></li><li><a href=//reddit.com/user/bniemyjski target=_blank title=Reddit><i class="fab fa-reddit"></i></a></li><li><a href=//youtube.com/bniemyjski target=_blank title=YouTube><i class="fab fa-youtube"></i></a></li><li><a href=//instagram.com/blake.niemyjski target=_blank title=Instagram><i class="fab fa-instagram"></i></a></li><li><a href=//twitter.com/blaken target=_blank title=Twitter><i class="fab fa-twitter"></i></a></li><li><a href=mailto:bniemyjski@gmail.com title=Email><i class="fas fa-envelope"></i></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><div class=posts-container><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/how-to-get-notifications-when-your-mailbox-is-opened/>How-to get notifications when your mailbox is opened</a></h3><time class=published datetime=2020-12-17>December 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/disturbing-trends-in-smart-home-products-and-services/>Disturbing trends in smart home products and services</a></h3><time class=published datetime=2020-12-02>December 2, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/securing-smart-home-devices-with-esphome-and-home-assistant/>Securing smart home devices with ESPHome and Home Assistant</a></h3><time class=published datetime=2020-10-17>October 17, 2020</time></header></article><article class=mini-post><header><h3><a href=https://blakeniemyjski.com/blog/building-and-maintaining-a-smart-home-presentation/>Building and maintaining a smart home presentation</a></h3><time class=published datetime=2020-08-25>August 25, 2020</time></header></article></div><a href=/categories/ class=button>View more posts</a></div></section><section id=mini-bio><h3>About</h3><p>Blake Niemyjski is a full time open source software architect and private pilot. Since the late 90's, Blake's curiosity has been focused around developing software that helps the masses. As a hobbyist developer turned student and professional, Blake's passion is to further his knowledge and create technologies for the future.</p><a href=https://blakeniemyjski.com/about/ class=button>Learn More About Me</a></section><section id=footer><p class=copyright>&copy; 2020
Blake Niemyjski
.
Powered by <a href=//gohugo.io target=_blank rel=noreferrer>Hugo</a></p></section></section></div><a id=back-to-top href=# class="fas fa-arrow-up fa-border fa-2x"></a><script defer src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js></script><script defer src=https://use.fontawesome.com/releases/v5.13.0/js/all.js></script><script defer src=https://blakeniemyjski.com/js/util.js></script><script defer src=https://blakeniemyjski.com/js/main.js></script><script defer src=https://blakeniemyjski.com/js/backToTop.js></script><script defer src=https://blakeniemyjski.com/js/disqusLoader.js></script><script defer src=https://blakeniemyjski.com/js/mailing-list.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/highlight.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/vbnet.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/dockerfile.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/languages/dos.min.js></script><script defer src=https://blakeniemyjski.com/js/init-highlight.js></script></body></html>